# Руководство по обмену сменами

## Обзор

Система обмена сменами позволяет сотрудникам обмениваться назначенными сменами с коллегами. Процесс включает три этапа: создание запроса, ответ коллеги и одобрение менеджера.

## Процесс обмена

### 1. Создание запроса

Сотрудник может запросить обмен своей смены:
- Выбрать смену в графике
- Выбрать коллегу для обмена
- Отправить запрос

**Ограничения:**
- Нельзя обменять смену в прошлом
- Нельзя создать запрос, если уже есть активный запрос на эту смену
- Нельзя обменяться с самим собой
- Коллега должен работать в том же ресторане

### 2. Ответ коллеги

Коллега получает уведомление и может:
- **Принять** - запрос переходит на одобрение менеджеру
- **Отклонить** - запрос закрывается

Срок ответа: 48 часов. После истечения срока запрос автоматически помечается как просроченный.

### 3. Одобрение менеджера

Менеджер (или сотрудник с правом `APPROVE_SHIFT_SWAP`) может:
- **Одобрить** - смена переназначается, оба сотрудника уведомляются
- **Отклонить** - запрос закрывается, оба сотрудника уведомляются

## Статусы запроса

| Статус | Описание |
|--------|----------|
| `PENDING` | Ожидает ответа коллеги |
| `ACCEPTED` | Принят коллегой, ожидает одобрения менеджера |
| `REJECTED` | Отклонен коллегой |
| `APPROVED` | Одобрен менеджером, обмен выполнен |
| `MANAGER_REJECTED` | Отклонен менеджером |
| `EXPIRED` | Истек срок ответа (48 часов) |

## Права доступа

- `REQUEST_SHIFT_SWAP` - право запрашивать обмен (по умолчанию у всех сотрудников)
- `APPROVE_SHIFT_SWAP` - право одобрять обмены (по умолчанию у менеджеров)

## API Endpoints

### Создание запроса
```
POST /api/swaps
Body: { shiftId: string, toUserId: string }
```

### Получение запросов
```
GET /api/swaps                    # Все запросы (с фильтрами)
GET /api/swaps/incoming           # Входящие запросы
GET /api/swaps/outgoing           # Исходящие запросы
GET /api/swaps/pending-approval   # Ожидающие одобрения
GET /api/swaps/:id                # Конкретный запрос
```

### Ответ на запрос
```
POST /api/swaps/:id/respond
Body: { accept: boolean }
```

### Одобрение запроса
```
POST /api/swaps/:id/approve
Body: { approve: boolean }
```

## Уведомления

На каждом этапе отправляются уведомления:

1. **При создании запроса** - коллега получает уведомление с кнопками "Принять/Отклонить"
2. **При ответе коллеги** - инициатор получает уведомление о решении
3. **При решении менеджера** - оба сотрудника получают уведомление

Уведомления отправляются:
- В приложении (in-app notifications)
- В Telegram (если привязан аккаунт)

## Telegram команды

- `/swaps` - показать активные запросы на обмен
- Интерактивные кнопки для принятия/отклонения запросов

## Настройки уведомлений

Пользователь может настроить:
- `enableSwapNotifications` - включить/выключить уведомления об обменах
- Настройки доступны через `/settings` в Telegram или в профиле

## История обменов

Все одобренные и отклоненные обмены сохраняются в таблице `ShiftSwapHistory` для аудита:
- Кто с кем обменялся
- Какая смена
- Кто одобрил
- Дата и время
